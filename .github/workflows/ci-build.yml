# .github/workflows/ci-build.yml

name: Build, Test & Pack CI

on:
  workflow_call:

  workflow_dispatch:

jobs:
  build:
    name: Build Project
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      checks: write  # for the test reporter to create annotations on PRs

    env:
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

    steps:
      - name: âš™ Checkout
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: âš™ Setup Environment
        run: echo "DOTNET_TOOLS=${HOME}/.dotnet/tools" >> $GITHUB_ENV

      - name: âš™ Setup .NET
        uses: actions/setup-dotnet@v5.0.0
        with:
          dotnet-version: |
            9.0.x
            8.0.x
            7.0.x
            6.0.x
          cache: true
          cache-dependency-path: '**/packages.lock.json'

      - name: ğŸš§ Display .NET Version
        run: dotnet --info

      - name: ğŸ§° Cache .NET Tools
        uses: actions/cache@v4.3.0
        with:
          path: ${{ env.DOTNET_TOOLS }}
          key: ${{ runner.os }}-dotnet-tools-${{ hashFiles('**/dotnet-tools.json') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-tools-

      - name: ğŸª› Install .NET Tools
        run: dotnet tool restore

      - name: ğŸ§© Restore Dependencies
        run: dotnet restore --locked-mode

      - name: â„¹ï¸ Get Version Information
        id: gitversion # give the step an ID to reference its output
        run: |
          echo 'json<<EOF' >> $GITHUB_OUTPUT
          dotnet gitversion /output json >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: ğŸ› ï¸ Build
        run: dotnet build -c Release --no-restore

      - name: ğŸ”§ Rebuild project if failed
        if: ${{ failure() }}
        run: |
          chmod +x scripts/clean.sh || true
          ./scripts/clean.sh || true
          dotnet build -c Release -v detailed

      - name: ğŸ”§ Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: ğŸ§ª Test + Coverage (Cobertura via XPlat)
        run: |
          dotnet test -c Release --no-build  -v minimal \
            --results-directory ./test-results \
            --collect:"XPlat Code Coverage;Format=cobertura" \
            -- RunConfiguration.CollectSourceInformation=true \
            --logger GitHubActions

      - name: ğŸ¤ Merge Coverage Reports
        if: always()
        run: |
          reportgenerator \
            -reports:"test-results/**/coverage.cobertura.xml" \
            -targetdir:"coverage-report" \
            -reporttypes:"Cobertura;HtmlInline_AzurePipelines_Dark"

      - name: ğŸ“¦ Pack Packages
        run: |
          dotnet pack \
            -c Release \
            --no-build \
            --include-symbols \
            --include-source

      - name: ğŸ“Š Generate Build Summary
        if: always()
        run: |
          $gv = '${{ steps.gitversion.outputs.json }}' | ConvertFrom-Json
          echo "## ğŸš€ Build, Test & Pack Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Build Information" >> $env:GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $env:GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $env:GITHUB_STEP_SUMMARY
          echo ("| Version | **{0}** |" -f $gv.SemVer) >> $env:GITHUB_STEP_SUMMARY
          echo ("| Branch | `{0}` |" -f $gv.BranchName) >> $env:GITHUB_STEP_SUMMARY
          echo ("| Commit | `{0}` |" -f $gv.Sha.Substring(0,7)) >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh

      - name: ğŸ“¦ Add Packaged Artifacts to Summary
        if: always()
        run: |
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '### ğŸ“¦ Packaged Artifacts' >> $GITHUB_STEP_SUMMARY
          PACKAGES=$(ls -1 artifacts/package/release/*.nupkg 2>/dev/null | sed 's/^/- `/' | sed 's/$/`/')
          if [ -z "$PACKAGES" ]; then
            echo 'No packages were created' >> $GITHUB_STEP_SUMMARY
          else
            echo "$PACKAGES" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload Packages Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: packages-${{ github.sha }}
          path: artifacts/package/release/*
          if-no-files-found: error
          retention-days: 90

      - name: ğŸ“¤ Upload Coverage Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: coverage-report-${{ github.sha }}
          path: coverage-report/**
          retention-days: 14