# .github/workflows/ci-analyze.yml
name: Analyze CI

on:
  workflow_call:

  workflow_dispatch:

  schedule: # weekly launch on Wednesdays at 19:00 UTC
    - cron: '0 19 * * 3'

jobs:
  codeql:
    name: CodeQL
    if: ${{ vars.ENABLE_CODEQL_ANALYSIS == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write # to upload CodeQL results

    steps:
      - name: ‚öô Checkout
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 2

      - name: ‚öô Checkout PR
        if: ${{ github.event_name == 'pull_request' }}
        run: git checkout HEAD^2

      - name: ü´ô Initialize CodeQL
        uses: github/codeql-action/init@v3.30.6
        with:
          languages: csharp

      - name: üõ†Ô∏è Autobuild
        uses: github/codeql-action/autobuild@v3.30.6

      - name: ü©ª Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3.30.6

  dotnet-format:
    name: .NET Analyzers
    if: ${{ vars.ENABLE_DOTNET_ANALYSIS == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: ‚öô Checkout
        uses: actions/checkout@v5.0.0

      - name: ‚öô Setup .NET (for dotnet format)
        uses: actions/setup-dotnet@v5.0.0
        with:
          dotnet-version: 9.0.x

      - name: ü©ª Perform .NET Analysis
        run: |
          # The results of the analysis are usually strange, 
          # just get the warning messages and double-check yourself:
          dotnet format analyzers \
            --severity info \
            --verify-no-changes \
            --include src
        continue-on-error: true