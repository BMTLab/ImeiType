# .github/workflows/ci-analyze.yml

name: Analyze CI

on:
  workflow_call:

  workflow_dispatch:

  schedule: # weekly launch on Wednesdays at 19:00 UTC
    - cron: '0 19 * * 3'

# Concurrency control for standalone runs (manual or scheduled):
# - This ensures that each manual or scheduled run is unique and does not cancel others.
# - When this workflow is called by another workflow, these settings are ignored,
#   and the caller's concurrency rules apply.
concurrency:
  group: ${{ github.workflow }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  codeql:
    name: CodeQL
    # This job provides an advanced, custom CodeQL configuration.
    # It's disabled by default because this repository uses GitHub's "Default Setup" for CodeQL.
    # Running both will cause an upload error.
    # To enable this:
    # 1. Disable "Default Setup" in repository settings.
    # 2. Set the `ENABLE_CODEQL_ANALYSIS` repository variable to `true`.
    if: ${{ vars.ENABLE_CODEQL_ANALYSIS == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write # to upload CodeQL results

    steps:
      - name: âš™ Checkout
        uses: actions/checkout@v5.0.0
        with:
          # Fetch all history for all branches and tags.
          # This is required for tools like GitVersion that analyze commit history.
          fetch-depth: 0

      - name: âš™ Checkout PR
        if: ${{ github.event_name == 'pull_request' }}
        run: git checkout HEAD^2

      - name: ðŸ«™ Initialize CodeQL
        uses: github/codeql-action/init@v3.30.6
        with:
          languages: csharp
          # This mode skips the auto-build step, significantly speeding up the analysis.
          # It works well for many standard .NET projects.
          build-mode: none

      - name: ðŸ©» Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3.30.6

  dotnet-format:
    name: .NET Analyzers
    if: ${{ vars.ENABLE_DOTNET_ANALYSIS == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: âš™ Checkout
        uses: actions/checkout@v5.0.0

      - name: âš™ Setup .NET (for dotnet format)
        uses: actions/setup-dotnet@v5.0.0
        with:
          dotnet-version: 9.0.x

      - name: ðŸ©» Perform .NET Analysis
        run: |
          # The results of the analysis are usually strange, 
          # just get the warning messages and double-check yourself:
          dotnet format analyzers \
            --severity info \
            --verify-no-changes \
            --include src
        continue-on-error: true