# .github/workflows/ci-release.yml

name: Release Packages CI

on:
  workflow_call:
    secrets:
      NUGET_API_KEY:
        required: true

env:
  RELEASE_DIR: release

jobs:
  verify-tag:
    name: Verify Before Publish
    timeout-minutes: 5
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      version: ${{ steps.check_tag_version.outputs.version }}
      is_prerelease: ${{ steps.check_tag_version.outputs.is_prerelease }}
      is_latest: ${{ steps.check_tag_version.outputs.is_latest }}
      is_publishable: ${{ steps.check_tag_version.outputs.is_publishable }}

    steps:
      - name: 🛡️ Check Permissions
        run: |
          echo '::group::Context'
          echo "GitHub Actor: '${{ github.actor }}'"
          echo "Repository Owner: '${{ github.repository_owner }}'"
          echo '::endgroup::'

          echo '::group::Permission check'
          if [ '${{ github.actor }}' != '${{ github.repository_owner }}' ]; then
            echo 'Only the repository owner can publish' >&2
            echo '::endgroup::'
            exit 103
          fi
          echo '✅ Publisher permissions confirmed!' >> "$GITHUB_STEP_SUMMARY"
          echo '::endgroup::'
          #######################################################

      - name: ⚙ Checkout Check Tag Action
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: 🔝 Check Tag Version
        id: check_tag_version
        uses: ./.github/actions/check-tag-action
        timeout-minutes: 5
        with:
          version: ${{ github.ref_name }}
          allowed_prerelease_suffix_regex: '^(alpha|beta|rc)$'

  push-nuget:
    name: Push To NuGet
    needs: verify-tag
    if: ${{ needs.verify-tag.outputs.is_publishable == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions: { }

    steps:
      - name: ⚙ Setup .NET (for nuget)
        # We are installing dotnet just to get the dotnet nuget command available,
        # building projects and packaging has already been done previously.
        uses: actions/setup-dotnet@v5.0.0
        with:
          dotnet-version: 9.0.x

      - name: 📥 Download Packages
        uses: actions/download-artifact@v5.0.0
        with:
          name: packages-${{ github.sha }}
          path: ${{ env.RELEASE_DIR }}

      - name: 📣 Publish to NuGet
        run: >-
          dotnet nuget push ${{ env.RELEASE_DIR }}/*.nupkg
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source ${{ vars.NUGET_SOURCE || 'https://api.nuget.org/v3/index.json' }}
          --skip-duplicate
        env:
          DOTNET_NOLOGO: true
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
          DOTNET_CLI_TELEMETRY_OPTOUT: 1

  create-release:
    name: Create Release
    needs: verify-tag
    if: ${{ needs.verify-tag.outputs.is_publishable == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write # to create a GitHub Release and upload assets

    steps:
      - name: 📥 Download Packages
        uses: actions/download-artifact@v5.0.0
        with:
          name: packages-${{ github.sha }}
          path: ${{ env.RELEASE_DIR }}

      - name: 📯 Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2.4.1
        with:
          name: 'Release ${{ needs.verify-tag.outputs.version }}'
          generate_release_notes: true
          files: ${{ env.RELEASE_DIR }}/*
          prerelease: ${{ needs.verify-tag.outputs.is_prerelease == 'true' }}
          make_latest: ${{ needs.verify-tag.outputs.is_latest == 'true' }}

      - name: 🖨️ Report Release
        run: |
          {
            echo '## New Release ${{ needs.verify-tag.outputs.version }}'
            echo '_ID: ${{ steps.create_release.outputs.id }}_'
            echo 'URL: ${{ steps.create_release.outputs.url }}'
          } >> "$GITHUB_STEP_SUMMARY"
        continue-on-error: true